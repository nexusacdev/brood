<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Brood üß¨ - Evolving AI Agents</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; }
    .mono { font-family: 'JetBrains Mono', monospace; }
    .glow { box-shadow: 0 0 20px rgba(34, 197, 94, 0.3); }
    .glow-spawn { animation: spawnGlow 2s ease-out; }
    .glow-death { animation: deathGlow 2s ease-out; }
    @keyframes spawnGlow {
      0% { box-shadow: 0 0 30px rgba(34, 197, 94, 0.8); background: rgba(34, 197, 94, 0.2); }
      100% { box-shadow: none; background: transparent; }
    }
    @keyframes deathGlow {
      0% { box-shadow: 0 0 30px rgba(239, 68, 68, 0.8); background: rgba(239, 68, 68, 0.2); }
      100% { box-shadow: none; background: transparent; }
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .pulse { animation: pulse 2s infinite; }
    .live-dot {
      width: 8px; height: 8px;
      background: #22c55e;
      border-radius: 50%;
      animation: pulse 1.5s infinite;
    }
    .tree-connector {
      border-left: 2px dashed #4b5563;
      margin-left: 12px;
      padding-left: 12px;
    }
  </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
  <!-- Header -->
  <header class="border-b border-gray-800 p-4">
    <div class="max-w-6xl mx-auto flex items-center justify-between">
      <div class="flex items-center gap-3">
        <span class="text-3xl">üß¨</span>
        <div>
          <h1 class="text-2xl font-bold">Brood</h1>
          <p class="text-sm text-gray-400">Self-Replicating AI Agents on Solana</p>
        </div>
      </div>
      <div class="flex items-center gap-6">
        <div class="flex items-center gap-2">
          <div class="live-dot" id="connection-dot"></div>
          <span class="text-sm text-gray-400" id="connection-status">Connecting...</span>
        </div>
        <div class="text-right">
          <div class="text-sm text-gray-400">Network</div>
          <div class="text-green-400 font-semibold">Devnet</div>
        </div>
        <div class="text-right">
          <div class="text-sm text-gray-400">Program</div>
          <a href="https://explorer.solana.com/address/2Au3HkZn7qQn4FgCSiH9cJGzPHtzGSmmmjaQhDXF5ZNV?cluster=devnet" 
             target="_blank" class="mono text-xs text-blue-400 hover:underline">
            2Au3...5ZNV
          </a>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="max-w-6xl mx-auto p-6">
    <!-- Stats Bar -->
    <div class="grid grid-cols-5 gap-4 mb-8">
      <div class="bg-gray-800 rounded-lg p-4">
        <div class="text-gray-400 text-sm">Total Agents</div>
        <div class="text-3xl font-bold" id="stat-total">-</div>
      </div>
      <div class="bg-gray-800 rounded-lg p-4">
        <div class="text-gray-400 text-sm">Alive</div>
        <div class="text-3xl font-bold text-green-400" id="stat-alive">-</div>
      </div>
      <div class="bg-gray-800 rounded-lg p-4">
        <div class="text-gray-400 text-sm">Dead</div>
        <div class="text-3xl font-bold text-red-400" id="stat-dead">-</div>
      </div>
      <div class="bg-gray-800 rounded-lg p-4">
        <div class="text-gray-400 text-sm">Max Generation</div>
        <div class="text-3xl font-bold text-purple-400" id="stat-gen">-</div>
      </div>
      <div class="bg-gray-800 rounded-lg p-4">
        <div class="text-gray-400 text-sm">Total Treasury</div>
        <div class="text-3xl font-bold text-yellow-400" id="stat-treasury">-</div>
      </div>
    </div>

    <!-- Family Trees + Agent Detail -->
    <div class="grid grid-cols-2 gap-6">
      <!-- Tree View -->
      <div class="bg-gray-800 rounded-lg p-6">
        <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
          <span>üå≥</span> Family Trees
          <span class="text-sm font-normal text-gray-500 ml-auto" id="last-update">-</span>
        </h2>
        <div id="tree-container" class="space-y-4 max-h-[500px] overflow-y-auto">
          <div class="text-gray-500 text-center py-8">Loading agents...</div>
        </div>
      </div>

      <!-- Agent Detail -->
      <div class="bg-gray-800 rounded-lg p-6">
        <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
          <span>ü§ñ</span> Agent Details
        </h2>
        <div id="agent-detail" class="text-gray-500 text-center py-8">
          Select an agent to view details
        </div>
      </div>
    </div>

    <!-- Market Prices -->
    <div class="mt-6 grid grid-cols-2 gap-6">
      <div class="bg-gray-800 rounded-lg p-6">
        <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
          <span>üìà</span> Live Prices (Mainnet)
        </h2>
        <div id="market-prices" class="grid grid-cols-2 gap-2 text-sm">
          <div class="text-gray-500">Loading prices...</div>
        </div>
      </div>

      <!-- Trading Activity -->
      <div class="bg-gray-800 rounded-lg p-6">
        <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
          <span>üíπ</span> Trading Activity
        </h2>
        <div id="trading-activity" class="space-y-2 max-h-64 overflow-y-auto">
          <div class="text-gray-500 text-sm">Run simulation to see trades...</div>
        </div>
      </div>
    </div>

    <!-- Agent Performance -->
    <div class="mt-6 bg-gray-800 rounded-lg p-6">
      <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
        <span>üèÜ</span> Agent Performance
      </h2>
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead class="text-left text-gray-400 border-b border-gray-700">
            <tr>
              <th class="pb-2">Agent</th>
              <th class="pb-2">Gen</th>
              <th class="pb-2">Treasury</th>
              <th class="pb-2">Trades</th>
              <th class="pb-2">W/L</th>
              <th class="pb-2">Win Rate</th>
              <th class="pb-2">P&L</th>
            </tr>
          </thead>
          <tbody id="performance-table" class="text-gray-300">
            <tr><td colspan="7" class="text-gray-500 py-4">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Evolution Log -->
    <div class="mt-6 bg-gray-800 rounded-lg p-6">
      <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
        <span>üìú</span> Evolution Log
        <span class="text-sm font-normal text-gray-500">(Live)</span>
      </h2>
      <div id="evolution-log" class="mono text-sm space-y-1 max-h-48 overflow-y-auto">
        <div class="text-gray-500">Watching for events...</div>
      </div>
    </div>

    <!-- Controls -->
    <div class="mt-6 flex gap-4">
      <button onclick="refreshNow()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg flex items-center gap-2">
        üîÑ Refresh
      </button>
      <div class="flex items-center gap-2 ml-auto text-sm text-gray-400">
        <span>Auto-refresh:</span>
        <select id="refresh-interval" onchange="setRefreshInterval()" class="bg-gray-700 rounded px-2 py-1">
          <option value="0">Off</option>
          <option value="5000">5s</option>
          <option value="10000" selected>10s</option>
          <option value="30000">30s</option>
        </select>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="border-t border-gray-800 p-4 mt-8">
    <div class="max-w-6xl mx-auto flex items-center justify-between text-sm text-gray-500">
      <div>Built for <a href="https://colosseum.com/agent-hackathon" class="text-blue-400 hover:underline">Colosseum Agent Hackathon</a></div>
      <div class="flex items-center gap-4">
        <a href="https://github.com/nexusacdev/brood" class="hover:text-gray-300">GitHub</a>
        <a href="https://twitter.com/nexusacdev" class="hover:text-gray-300">Twitter</a>
      </div>
    </div>
  </footer>

  <script>
    const PROGRAM_ID = '2Au3HkZn7qQn4FgCSiH9cJGzPHtzGSmmmjaQhDXF5ZNV';
    const OWNER = '8tERnd2H3pijcVZLG4qUVzB1SpAGVK8ToKXgU2yB9ppQ';
    const LAMPORTS_PER_SOL = 1000000000;
    
    // Pre-computed PDAs (browser PDA derivation is unreliable)
    const AGENT_PDAS = {
      "Alpha-719523": "GNKK2DfA4hJwPTNqG3UZNFdH89QeYoA2NTnEVQx15FX6",
      "Eve-9682": "HvM2JtmSobBUNNevKnx3kYBXSJEWfEciKuLanY4KxTZW",
      "Child-0906": "4ikPy2c89vbRYQCpN2n5cnYVSMeq39vWad8gGxiPQKnz",
      "Adam-8379": "6qqRCYRM2LAJvprPMB3WZW3Znw8cVc5nvJkY7ZHQG6rM",
      "Adam-7274": "2GsdTh8mk5prTJLkiX9DfPewy2Xvg7veiYer2XYVtvyq",
      "Cain-0113": "5oimH3a2i51QxeM3QC54U4sTkqt6EnaouTwSpznvu7bV",
      "Abel-1612": "GDuCd6aE62ZZw46q39KyKP6FJNsHhAZmymiwftdTESTD",
      "Enoch-4211": "4xB859aXGY4MSDE3xFfS2iZAoTZKkKKDhhKDCkS54Trd",
      "Gen3-4521": "D64dK5ov5VjBTaYm9AqudfrmBMSgm1ryNVrXknSRAibt",
    };

    let connection;
    let agents = new Map();
    let previousAgents = new Map();
    let selectedAgent = null;
    let refreshTimer = null;
    let subscriptionId = null;
    let eventLogCleared = false;

    async function init() {
      connection = new solanaWeb3.Connection('https://api.devnet.solana.com', 'confirmed');
      
      // Initial load
      await loadAgents();
      renderTree();
      updateStats();
      
      // Start auto-refresh
      setRefreshInterval();
      
      // Subscribe to program logs
      subscribeToLogs();
      
      updateConnectionStatus('connected');
    }

    function updateConnectionStatus(status) {
      const dot = document.getElementById('connection-dot');
      const text = document.getElementById('connection-status');
      
      if (status === 'connected') {
        dot.style.background = '#22c55e';
        text.textContent = 'Live';
      } else if (status === 'error') {
        dot.style.background = '#ef4444';
        text.textContent = 'Disconnected';
      } else {
        dot.style.background = '#eab308';
        text.textContent = 'Connecting...';
      }
    }

    function getAgentPDA(owner, name) {
      const programId = new solanaWeb3.PublicKey(PROGRAM_ID);
      const [pda] = solanaWeb3.PublicKey.findProgramAddressSync(
        [
          Buffer.from('agent'),
          new solanaWeb3.PublicKey(owner).toBuffer(),
          Buffer.from(name)
        ],
        programId
      );
      return pda;
    }

    async function loadAgents() {
      // Save previous state for diff detection
      previousAgents = new Map(agents);
      agents.clear();
      
      // Load each known agent by hardcoded PDA address
      for (const [name, pdaAddress] of Object.entries(AGENT_PDAS)) {
        try {
          const pda = new solanaWeb3.PublicKey(pdaAddress);
          const accountInfo = await connection.getAccountInfo(pda);
          
          if (accountInfo) {
            const agent = parseAgentAccount(accountInfo.data, pda.toBase58());
            if (agent && agent.name) {
              agents.set(agent.id, agent);
            }
          }
        } catch (e) {
          console.error('Error loading', name, e);
        }
      }
      
      // Detect changes and log them
      detectChanges();
      
      // Update timestamp
      document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
    }

    function detectChanges() {
      // Find new agents (spawns)
      for (const [id, agent] of agents) {
        if (!previousAgents.has(id)) {
          addLogEntry(`‚ú® <span class="text-green-400">SPAWN:</span> ${agent.name} (Gen ${agent.generation}) born!`, 'spawn');
          highlightAgent(id, 'spawn');
        }
      }
      
      // Find removed agents or status changes
      for (const [id, prevAgent] of previousAgents) {
        const currentAgent = agents.get(id);
        if (currentAgent) {
          // Check for death
          if (prevAgent.isAlive && !currentAgent.isAlive) {
            addLogEntry(`üíÄ <span class="text-red-400">DEATH:</span> ${currentAgent.name} has died`, 'death');
            highlightAgent(id, 'death');
          }
          // Check for treasury changes
          const treasuryDiff = currentAgent.treasury - prevAgent.treasury;
          if (Math.abs(treasuryDiff) > 1000000) { // > 0.001 SOL
            const diffStr = treasuryDiff > 0 
              ? `+${(treasuryDiff/LAMPORTS_PER_SOL).toFixed(4)}`
              : (treasuryDiff/LAMPORTS_PER_SOL).toFixed(4);
            const icon = treasuryDiff > 0 ? 'üìà' : 'üìâ';
            addLogEntry(`${icon} ${currentAgent.name}: ${diffStr} SOL`);
          }
          // Check for new spawns
          if (currentAgent.spawnCount > prevAgent.spawnCount) {
            addLogEntry(`üë∂ ${currentAgent.name} spawned a child!`, 'spawn');
          }
        }
      }
    }

    function highlightAgent(id, type) {
      setTimeout(() => {
        const el = document.querySelector(`[data-agent-id="${id}"]`);
        if (el) {
          el.classList.add(type === 'spawn' ? 'glow-spawn' : 'glow-death');
          setTimeout(() => el.classList.remove('glow-spawn', 'glow-death'), 2000);
        }
      }, 100);
    }

    function parseAgentAccount(data, pubkey) {
      // Skip 8-byte discriminator
      let offset = 8;
      
      const id = new solanaWeb3.PublicKey(data.slice(offset, offset + 32)).toBase58();
      offset += 32;
      
      const owner = new solanaWeb3.PublicKey(data.slice(offset, offset + 32)).toBase58();
      offset += 32;
      
      const hasParent = data[offset] === 1;
      offset += 1;
      let parent = null;
      if (hasParent) {
        parent = new solanaWeb3.PublicKey(data.slice(offset, offset + 32)).toBase58();
        offset += 32;
      }
      
      const generation = data.readUInt32LE(offset);
      offset += 4;
      
      const nameLen = data.readUInt32LE(offset);
      offset += 4;
      const agentName = data.slice(offset, offset + nameLen).toString();
      offset += nameLen;
      
      const genomeHash = Array.from(data.slice(offset, offset + 32));
      offset += 32;
      
      const uriLen = data.readUInt32LE(offset);
      offset += 4;
      const genomeUri = data.slice(offset, offset + uriLen).toString();
      offset += uriLen;
      
      const treasury = Number(data.readBigUInt64LE(offset));
      offset += 8;
      
      const totalEarnings = Number(data.readBigUInt64LE(offset));
      offset += 8;
      
      const totalCosts = Number(data.readBigUInt64LE(offset));
      offset += 8;
      
      const spawnCount = data.readUInt32LE(offset);
      offset += 4;
      
      const serviceCount = data.readUInt32LE(offset);
      offset += 4;
      
      const createdAt = Number(data.readBigInt64LE(offset));
      offset += 8;
      
      const lastActive = Number(data.readBigInt64LE(offset));
      offset += 8;
      
      const isAlive = data[offset] === 1;
      
      return {
        id,
        pubkey,
        owner,
        parent,
        generation,
        name: agentName,
        genomeHash,
        genomeUri,
        treasury,
        totalEarnings,
        totalCosts,
        spawnCount,
        serviceCount,
        createdAt,
        lastActive,
        isAlive
      };
    }

    function renderTree() {
      const container = document.getElementById('tree-container');
      
      // Build tree structure
      const roots = [];
      const children = new Map();
      
      for (const agent of agents.values()) {
        if (!agent.parent) {
          roots.push(agent);
        } else {
          if (!children.has(agent.parent)) {
            children.set(agent.parent, []);
          }
          children.get(agent.parent).push(agent);
        }
      }
      
      if (roots.length === 0) {
        container.innerHTML = '<div class="text-gray-500 text-center py-8">No agents found on devnet</div>';
        return;
      }
      
      // Sort roots by generation then name
      roots.sort((a, b) => a.generation - b.generation || a.name.localeCompare(b.name));
      
      function renderAgent(agent, depth = 0) {
        const agentChildren = (children.get(agent.id) || []).sort((a, b) => 
          a.generation - b.generation || a.createdAt - b.createdAt
        );
        const status = agent.isAlive ? 'üü¢' : 'üíÄ';
        const treasury = (agent.treasury / LAMPORTS_PER_SOL).toFixed(3);
        const canSpawn = agent.treasury >= 120000000 && agent.isAlive;
        
        return `
          <div class="rounded transition-all duration-300" data-agent-id="${agent.id}">
            <div class="cursor-pointer hover:bg-gray-700 rounded p-2 transition-colors ${selectedAgent?.id === agent.id ? 'bg-gray-700 ring-1 ring-blue-500' : ''}" 
                 onclick="selectAgent('${agent.id}')"
                 style="margin-left: ${depth * 24}px">
              <div class="flex items-center gap-2">
                ${depth > 0 ? '<span class="text-gray-600">‚îú‚îÄ</span>' : ''}
                <span>${status}</span>
                <span class="font-semibold">${agent.name}</span>
                <span class="text-xs px-1.5 py-0.5 rounded bg-purple-900 text-purple-300">Gen ${agent.generation}</span>
                ${canSpawn ? '<span class="text-xs px-1.5 py-0.5 rounded bg-green-900 text-green-300">‚ú® Can Spawn</span>' : ''}
              </div>
              <div class="text-sm text-gray-400 ml-6 flex gap-3">
                <span>üí∞ ${treasury} SOL</span>
                <span>üë∂ ${agent.spawnCount} spawns</span>
                <span>üîß ${agent.serviceCount} services</span>
              </div>
            </div>
            ${agentChildren.length > 0 ? `
              <div class="tree-connector">
                ${agentChildren.map(child => renderAgent(child, depth + 1)).join('')}
              </div>
            ` : ''}
          </div>
        `;
      }
      
      container.innerHTML = roots.map(r => renderAgent(r)).join('<div class="border-t border-gray-700 my-4"></div>');
    }

    function selectAgent(id) {
      selectedAgent = agents.get(id);
      renderTree(); // Re-render to show selection
      renderAgentDetail();
    }

    function renderAgentDetail() {
      const container = document.getElementById('agent-detail');
      
      if (!selectedAgent) {
        container.innerHTML = '<div class="text-gray-500 text-center py-8">Select an agent to view details</div>';
        return;
      }
      
      const a = selectedAgent;
      const status = a.isAlive 
        ? '<span class="text-green-400 flex items-center gap-1"><span class="w-2 h-2 bg-green-400 rounded-full"></span> Alive</span>' 
        : '<span class="text-red-400 flex items-center gap-1"><span class="w-2 h-2 bg-red-400 rounded-full"></span> Dead</span>';
      const treasury = (a.treasury / LAMPORTS_PER_SOL).toFixed(4);
      const earnings = (a.totalEarnings / LAMPORTS_PER_SOL).toFixed(4);
      const costs = (a.totalCosts / LAMPORTS_PER_SOL).toFixed(4);
      const created = new Date(a.createdAt * 1000).toLocaleString();
      const lastActive = new Date(a.lastActive * 1000).toLocaleString();
      const canSpawn = a.treasury >= 120000000 && a.isAlive;
      const spawnProgress = Math.min(100, (a.treasury / 120000000) * 100);
      
      // Find parent name
      let parentName = 'None (Genesis)';
      if (a.parent) {
        for (const agent of agents.values()) {
          if (agent.id === a.parent) {
            parentName = agent.name;
            break;
          }
        }
        if (parentName === 'None (Genesis)') parentName = a.parent.slice(0, 8) + '...';
      }
      
      // Find children
      const childrenList = Array.from(agents.values()).filter(ag => ag.parent === a.id);
      
      container.innerHTML = `
        <div class="space-y-4">
          <div class="flex items-center justify-between">
            <h3 class="text-xl font-bold">${a.name}</h3>
            <div>${status}</div>
          </div>
          
          <div class="grid grid-cols-2 gap-4 text-sm">
            <div class="bg-gray-900 rounded p-3">
              <div class="text-gray-400">Generation</div>
              <div class="text-2xl font-bold text-purple-400">${a.generation}</div>
            </div>
            <div class="bg-gray-900 rounded p-3">
              <div class="text-gray-400">Treasury</div>
              <div class="text-2xl font-bold text-yellow-400">${treasury} SOL</div>
            </div>
            <div class="bg-gray-900 rounded p-3">
              <div class="text-gray-400">Spawns</div>
              <div class="text-2xl font-bold">${a.spawnCount}</div>
            </div>
            <div class="bg-gray-900 rounded p-3">
              <div class="text-gray-400">Services</div>
              <div class="text-2xl font-bold">${a.serviceCount}</div>
            </div>
          </div>
          
          ${a.isAlive ? `
          <div class="bg-gray-900 rounded p-3">
            <div class="flex justify-between text-sm mb-1">
              <span class="text-gray-400">Spawn Progress</span>
              <span>${canSpawn ? '‚ú® Ready!' : `${spawnProgress.toFixed(0)}%`}</span>
            </div>
            <div class="w-full bg-gray-700 rounded-full h-2">
              <div class="h-2 rounded-full transition-all ${canSpawn ? 'bg-green-500' : 'bg-blue-500'}" 
                   style="width: ${spawnProgress}%"></div>
            </div>
            <div class="text-xs text-gray-500 mt-1">Need 0.12 SOL to spawn</div>
          </div>
          ` : ''}
          
          <div class="text-sm space-y-2 border-t border-gray-700 pt-4">
            <div class="flex justify-between">
              <span class="text-gray-400">Total Earnings</span>
              <span class="text-green-400">+${earnings} SOL</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-400">Total Costs</span>
              <span class="text-red-400">-${costs} SOL</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-400">Parent</span>
              <span>${parentName}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-400">Created</span>
              <span>${created}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-400">Last Active</span>
              <span>${lastActive}</span>
            </div>
          </div>
          
          ${childrenList.length > 0 ? `
          <div class="border-t border-gray-700 pt-4">
            <div class="text-gray-400 text-sm mb-2">Children (${childrenList.length})</div>
            <div class="flex flex-wrap gap-2">
              ${childrenList.map(c => `
                <span class="text-xs px-2 py-1 rounded bg-gray-700 cursor-pointer hover:bg-gray-600"
                      onclick="selectAgent('${c.id}')">
                  ${c.isAlive ? 'üü¢' : 'üíÄ'} ${c.name}
                </span>
              `).join('')}
            </div>
          </div>
          ` : ''}
          
          <div class="border-t border-gray-700 pt-4">
            <div class="text-gray-400 text-sm mb-2">Agent PDA</div>
            <div class="mono text-xs bg-gray-900 p-2 rounded break-all">
              <a href="https://explorer.solana.com/address/${a.id}?cluster=devnet" 
                 target="_blank" class="text-blue-400 hover:underline">${a.id}</a>
            </div>
          </div>
          
          <div>
            <div class="text-gray-400 text-sm mb-2">Genome URI</div>
            <div class="mono text-xs bg-gray-900 p-2 rounded break-all">${a.genomeUri || 'Not set'}</div>
          </div>
        </div>
      `;
    }

    function updateStats() {
      const total = agents.size;
      const alive = Array.from(agents.values()).filter(a => a.isAlive).length;
      const dead = total - alive;
      const maxGen = Math.max(...Array.from(agents.values()).map(a => a.generation), 0);
      const totalTreasury = Array.from(agents.values()).reduce((sum, a) => sum + a.treasury, 0);
      
      document.getElementById('stat-total').textContent = total;
      document.getElementById('stat-alive').textContent = alive;
      document.getElementById('stat-dead').textContent = dead;
      document.getElementById('stat-gen').textContent = maxGen;
      document.getElementById('stat-treasury').textContent = (totalTreasury / LAMPORTS_PER_SOL).toFixed(2);
    }

    function addLogEntry(message, type = 'info') {
      const log = document.getElementById('evolution-log');
      
      // Clear initial message
      if (!eventLogCleared) {
        log.innerHTML = '';
        eventLogCleared = true;
      }
      
      const time = new Date().toLocaleTimeString();
      const entry = document.createElement('div');
      entry.className = 'py-1 border-b border-gray-800';
      entry.innerHTML = `<span class="text-gray-500">[${time}]</span> ${message}`;
      log.prepend(entry);
      
      // Limit to 50 entries
      while (log.children.length > 50) {
        log.removeChild(log.lastChild);
      }
    }

    async function subscribeToLogs() {
      try {
        const programId = new solanaWeb3.PublicKey(PROGRAM_ID);
        
        subscriptionId = connection.onLogs(programId, (logs) => {
          // Parse log messages for events
          for (const log of logs.logs) {
            if (log.includes('spawn')) {
              addLogEntry(`üîî On-chain spawn event detected`, 'spawn');
              refreshNow();
            } else if (log.includes('kill') || log.includes('death')) {
              addLogEntry(`üîî On-chain death event detected`, 'death');
              refreshNow();
            } else if (log.includes('deposit') || log.includes('withdraw')) {
              addLogEntry(`üîî Treasury change detected`);
              refreshNow();
            }
          }
        }, 'confirmed');
        
        addLogEntry('üì° Subscribed to on-chain events');
      } catch (e) {
        console.error('Failed to subscribe to logs:', e);
        addLogEntry('‚ö†Ô∏è Could not subscribe to events, using polling only');
      }
    }

    function setRefreshInterval() {
      if (refreshTimer) clearInterval(refreshTimer);
      
      const interval = parseInt(document.getElementById('refresh-interval').value);
      if (interval > 0) {
        refreshTimer = setInterval(async () => {
          await loadAgents();
          renderTree();
          updateStats();
          if (selectedAgent) {
            selectedAgent = agents.get(selectedAgent.id);
            renderAgentDetail();
          }
        }, interval);
      }
    }

    async function refreshNow() {
      addLogEntry('üîÑ Refreshing...');
      await loadAgents();
      renderTree();
      updateStats();
      updatePerformanceTable();
      await fetchMarketPrices();
      await loadTradingState();
      updateTradingActivity();
      if (selectedAgent) {
        selectedAgent = agents.get(selectedAgent.id);
        renderAgentDetail();
      }
    }

    // Token addresses for price fetching
    const TRACKED_TOKENS = [
      { symbol: 'SOL', address: 'So11111111111111111111111111111111111111112' },
      { symbol: 'BONK', address: 'DezXAZ8z7PnrnRJjz3wXBoRgixCa6xjnB7YaB1pPB263' },
      { symbol: 'WIF', address: 'EKpQGSJtjMFqKZ9KQanSqYXRcF8fBopzLHYxdM65zcjm' },
      { symbol: 'JUP', address: 'JUPyiwrYJFskUPiHa7hkeR8VUtAeFoSYbKedZNsDvCN' },
      { symbol: 'PYTH', address: 'HZ1JovNiVvGrGNiiYvEozEVgZ58xaU3RKwX8eACQBCt3' },
      { symbol: 'RAY', address: '4k3Dyjzvzp8eMZWUXbBCjEvwSkkk59S5iCNLY3QrkX6R' },
    ];

    let marketPrices = new Map();
    let tradingState = null;

    async function fetchMarketPrices() {
      const container = document.getElementById('market-prices');
      try {
        const prices = [];
        for (const token of TRACKED_TOKENS) {
          try {
            const response = await fetch(`https://api.dexscreener.com/latest/dex/tokens/${token.address}`);
            const data = await response.json();
            if (data.pairs && data.pairs.length > 0) {
              const pair = data.pairs.find(p => p.chainId === 'solana') || data.pairs[0];
              const price = parseFloat(pair.priceUsd);
              const change = pair.priceChange?.h24 || 0;
              prices.push({ symbol: token.symbol, price, change });
              marketPrices.set(token.symbol, price);
            }
          } catch (e) {}
          await new Promise(r => setTimeout(r, 100)); // Rate limit
        }

        if (prices.length > 0) {
          container.innerHTML = prices.map(p => {
            const changeColor = p.change >= 0 ? 'text-green-400' : 'text-red-400';
            const changeStr = p.change >= 0 ? `+${p.change.toFixed(2)}` : p.change.toFixed(2);
            return `
              <div class="flex justify-between items-center bg-gray-900 rounded p-2">
                <span class="font-semibold">${p.symbol}</span>
                <div class="text-right">
                  <div>$${p.price < 0.01 ? p.price.toFixed(8) : p.price.toFixed(4)}</div>
                  <div class="text-xs ${changeColor}">${changeStr}%</div>
                </div>
              </div>
            `;
          }).join('');
          addLogEntry(`üìà Fetched ${prices.length} token prices`);
        }
      } catch (e) {
        container.innerHTML = '<div class="text-red-400">Failed to fetch prices</div>';
      }
    }

    async function loadTradingState() {
      // Load state from GitHub (CORS-friendly)
      const stateUrl = 'https://raw.githubusercontent.com/nexusacdev/brood/gh-pages/data/state.json';
      
      try {
        const response = await fetch(stateUrl + '?t=' + Date.now());
        if (response.ok) {
          tradingState = await response.json();
          if (tradingState && tradingState.round > 0) {
            const age = Math.floor((Date.now() - tradingState.timestamp) / 1000);
            addLogEntry(`üìä Trading data: Round ${tradingState.round} (${Math.floor(age/60)}m ago)`);
            return;
          }
        }
      } catch (e) {
        // State file not available
      }
    }

    function updatePerformanceTable() {
      const tbody = document.getElementById('performance-table');
      
      // Prefer trading state data if available (has W/L), fallback to on-chain
      if (tradingState && tradingState.agents && tradingState.agents.length > 0) {
        const sorted = tradingState.agents.sort((a, b) => {
          // Sort by win rate, then by total trades
          const aWinRate = (a.winCount + a.lossCount) > 0 ? a.winCount / (a.winCount + a.lossCount) : 0;
          const bWinRate = (b.winCount + b.lossCount) > 0 ? b.winCount / (b.winCount + b.lossCount) : 0;
          if (bWinRate !== aWinRate) return bWinRate - aWinRate;
          return b.tradeCount - a.tradeCount;
        });
        
        tbody.innerHTML = sorted.map((a, i) => {
          const medal = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : '';
          const totalSells = a.winCount + a.lossCount;
          const winRate = totalSells > 0 ? (a.winCount / totalSells * 100).toFixed(0) : '-';
          const winRateColor = totalSells > 0 ? (a.winCount / totalSells >= 0.5 ? 'text-green-400' : 'text-red-400') : 'text-gray-500';
          const pnlColor = a.totalPnL >= 0 ? 'text-green-400' : 'text-red-400';
          const pnlStr = a.totalPnL >= 0 ? `+${a.totalPnL.toFixed(4)}` : a.totalPnL.toFixed(4);
          
          return `
            <tr class="border-b border-gray-800 hover:bg-gray-700/50">
              <td class="py-2">${medal} ${a.isAlive ? 'üü¢' : 'üíÄ'} ${a.name}</td>
              <td class="py-2 text-purple-400">${a.generation}</td>
              <td class="py-2">${a.treasury.toFixed(4)} SOL</td>
              <td class="py-2">${a.tradeCount}</td>
              <td class="py-2">${a.winCount}/${a.lossCount}</td>
              <td class="py-2 ${winRateColor} font-semibold">${winRate}%</td>
              <td class="py-2 ${pnlColor}">${pnlStr}</td>
            </tr>
          `;
        }).join('');
        return;
      }
      
      // Fallback to on-chain data
      if (agents.size === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-gray-500 py-4">Loading agents...</td></tr>';
        return;
      }

      const agentList = Array.from(agents.values()).sort((a, b) => b.treasury - a.treasury);
      tbody.innerHTML = agentList.map((a, i) => {
        const medal = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : '';
        const treasury = a.treasury / LAMPORTS_PER_SOL;
        
        return `
          <tr class="border-b border-gray-800 hover:bg-gray-700/50 cursor-pointer" onclick="selectAgent('${a.id}')">
            <td class="py-2">${medal} ${a.isAlive ? 'üü¢' : 'üíÄ'} ${a.name}</td>
            <td class="py-2 text-purple-400">${a.generation}</td>
            <td class="py-2">${treasury.toFixed(4)} SOL</td>
            <td class="py-2">-</td>
            <td class="py-2">-</td>
            <td class="py-2 text-gray-500">-</td>
            <td class="py-2">-</td>
          </tr>
        `;
      }).join('');
    }

    function updateTradingActivity() {
      const container = document.getElementById('trading-activity');
      
      // Show trading info from JSONBlob if available, otherwise show placeholder
      if (tradingState && tradingState.agents) {
        const activities = [];
        for (const agent of tradingState.agents) {
          if (agent.positions && agent.positions.length > 0) {
            for (const pos of agent.positions) {
              const pnl = pos.pnlPercent || 0;
              const pnlColor = pnl >= 0 ? 'text-green-400' : 'text-red-400';
              activities.push({
                agent: agent.name,
                gen: agent.generation,
                token: pos.token,
                entryPrice: pos.entryPrice,
                currentPrice: pos.currentPrice || pos.entryPrice,
                pnl,
                pnlColor,
              });
            }
          }
        }

        if (activities.length > 0) {
          container.innerHTML = activities.map(a => `
            <div class="flex justify-between items-center bg-gray-900 rounded p-2 text-sm">
              <div>
                <span class="text-gray-400">${a.agent}</span>
                <span class="text-purple-400 text-xs ml-1">G${a.gen}</span>
                <span class="font-semibold ml-2">${a.token}</span>
              </div>
              <div class="text-right">
                <div class="text-xs text-gray-500">$${a.entryPrice.toFixed(6)} ‚Üí $${a.currentPrice.toFixed(6)}</div>
                <div class="${a.pnlColor} font-semibold">${a.pnl >= 0 ? '+' : ''}${a.pnl.toFixed(2)}%</div>
              </div>
            </div>
          `).join('');
          return;
        }
      }
      
      // Fallback: show instructions
      container.innerHTML = `
        <div class="text-gray-400 text-sm space-y-2">
          <div>Trading data from simulator</div>
          <div class="text-xs text-gray-500">Run: npx ts-node src/live-evolve.ts</div>
          <div class="text-xs text-gray-500">Logs: simulator/data/trades.json</div>
        </div>
      `;
    }

    // Initialize
    init().then(async () => {
      addLogEntry('üß¨ Dashboard initialized');
      addLogEntry(`üìä Found ${agents.size} agents on devnet`);
      
      // Update performance table with on-chain data
      updatePerformanceTable();
      
      // Fetch market prices
      await fetchMarketPrices();
      
      // Try to load trading state (may fail due to CORS)
      await loadTradingState();
      updateTradingActivity();
      
      // Refresh prices every 30s
      setInterval(fetchMarketPrices, 30000);
      setInterval(loadTradingState, 30000);
    }).catch(e => {
      console.error('Init failed:', e);
      updateConnectionStatus('error');
      addLogEntry('‚ùå Failed to connect: ' + e.message);
    });
  </script>
</body>
</html>
